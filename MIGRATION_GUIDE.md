# Руководство по миграции: два тарифа (Текст / Текст + Аудио)

Краткий чек-лист для существующих пользователей при переходе на тарифы «Текст» и «Текст + Аудио».

---

## Маппинг планов

- **free** → тариф **«Текст»** (`planType: "text"`): только текст, загрузка .txt, генерация по платформам. Аудио недоступно.
- **pro** / **enterprise** → тариф **«Текст + Аудио»** (`planType: "text_audio"`): текст + загрузка аудио, транскрипция Whisper, лимиты минут в месяц.

---

## Поведение старых проектов

- **Исходный контент:** без изменений. Поле `sourceContent` по-прежнему хранит текст (или результат последней транскрипции для проектов с аудио).
- **Content Pack:** при первой генерации после обновления для длинного текста строится Content Pack (если не было ошибки). Кэш Pack и outputs привязан к `projectId`; при изменении `sourceContent` через PATCH кэш по проекту инвалидируется.
- **Уже сгенерированные outputs:** остаются. Регенерация использует текущие `sourceContent` и (при наличии) Pack; при смене исходного текста старый кэш сбрасывается, новая генерация идёт заново.

---

## Что сделать при переходе

1. **Проверить план:** GET `/api/subscription/features` возвращает `planType`, `canUseAudio`, `audioLimits`. UI показывает бейдж тарифа и блок «Загрузить аудио» только при `canUseAudio === true`.
2. **Тариф «Текст»:** загрузка исходного текста — только через .txt или ввод в форму. Аудио не принимается (API вернёт 400).
3. **Тариф «Текст + Аудио»:** можно загружать аудио через POST `/api/projects/[id]/ingest-audio`. Учитываются лимиты минут в периоде и размер файла.
4. **Кэш:** при смене исходного текста проекта (PATCH с `sourceContent`) кэш генерации и Content Pack по этому проекту инвалидируется. Смена brand voice не инвалидирует кэш (срок жизни кэша 7 дней).

---

## Лимиты и стоимость

- **Аудио:** лимиты задаются в плане (`audioMinutesPerMonth`, `maxAudioFileSizeMb`). Использованные минуты хранятся в `subscription.audioMinutesUsedThisPeriod`.
- **Транскрипция:** в запись `Transcript` записывается `costEstimate` (оценка по $0.006/мин для Whisper). В `generationMetadata` поле `costEstimate` пока опционально (при появлении данных об использовании токенов может заполняться).

---

## Отдельные эндпоинты (опционально)

- **POST /api/projects/[id]/content-pack** — построить и вернуть Content Pack по проекту (без генерации постов).
- **POST /api/transcribe** — загрузить аудиофайл, вернуть только транскрипт (без привязки к проекту).
- Загрузка аудио в проект по-прежнему через **POST /api/projects/[id]/ingest-audio**.
