# Итоговый план исправления: авто-генерация при создании проекта

## 1) Целевое поведение
- При создании проекта с текстом генерация запускается автоматически сразу после `Create Project`.
- Промежуточный шаг ручного запуска генерации не используется как обязательный.
- Если генерация успешна: редирект на `/projects/[id]/outputs/[outputId]/edit` (первый успешный output).
- Если генерация частично успешна (`partial`): редирект на `/projects/[id]/generate` для отображения ошибок и retry.
- Если генерация полностью неуспешна (`failed`): редирект на `/projects/[id]/generate` с причиной ошибки и retry.
- Аудио-ветка создания проекта сохраняет текущую логику и не меняется в этом этапе.

## 2) Архитектура и контракт API
- Добавить серверный оркестратор `create + generate` (новый endpoint).
- Внутри endpoint:
  - валидация входных данных;
  - проверка авторизации, rate-limit, квот и тарифных ограничений;
  - создание проекта;
  - запуск генерации контента;
  - возврат структурированного результата.
- Контракт ответа:
  - `status: "success" | "partial" | "failed"`;
  - `projectId`;
  - `firstSuccessfulOutputId` (если есть);
  - `successful[]`, `failed[]`, `totalRequested`;
  - машиночитаемые коды ошибок для надежной обработки на клиенте.

## 3) Детерминированность и надежность
- Зафиксировать детерминированный выбор `firstSuccessfulOutputId` (по порядку успешных слотов генерации).
- Гарантировать атомарность бизнес-сценария:
  - проект создается один раз;
  - при сбое генерации проект не теряется;
  - состояние результата генерации прозрачно (`success/partial/failed`).
- Защитить UI от повторной отправки формы в одном сеансе (блокировка submit во время запроса).

## 4) Изменения на клиенте
- Для text create-flow переключить submit с `POST /api/projects` на новый endpoint оркестрации.
- Добавить ветвление роутинга по `status` ответа:
  - `success` -> `/projects/[id]/outputs/[outputId]/edit`;
  - `partial` -> `/projects/[id]/generate`;
  - `failed` -> `/projects/[id]/generate`.
- Удалять autosave draft после успешного создания проекта (включая `partial/failed`, если проект создан).
- Сохранить текущий edit-flow проекта без изменений.

## 5) Наблюдаемость и диагностика
- Добавить структурированные логи для нового сценария:
  - `requestId`, `userId`, `projectId`, `plan`, `requestedSlots`, `successful`, `failed`, `duration`.
- Явно логировать ошибки create и generate внутри оркестратора.

## 6) Тестирование
- Unit/интеграционные тесты для нового endpoint:
  - успешный сценарий;
  - partial;
  - failed;
  - ошибки валидации/лимитов/rate-limit.
- Регрессия существующих `POST /api/projects` и `POST /api/generate`.
- Smoke UI-проверка text create-flow:
  - нет обязательного промежуточного окна;
  - корректные редиректы по `status`.

## 7) Критерии приемки
- После создания текстового проекта генерация стартует автоматически.
- При полном успехе пользователь попадает сразу в редактор output.
- При partial/failed пользователь попадает на экран генерации с возможностью retry.
- Аудио-сценарий работает как ранее.
- Комментарии в коде, добавленные в рамках задачи, только на английском.
